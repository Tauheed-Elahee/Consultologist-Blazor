@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Text.Json
@inject HttpClient Http
@attribute [Authorize]

@page "/profile"

<PageTitle>Profile</PageTitle>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="24">
    <FluentLabel Typo="Typography.H3">Your Profile</FluentLabel>

    <AuthorizeView>
        <Authorized>
            @if (graphApiResponse != null)
            {
                <FluentCard>
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
                        <FluentLabel Typo="Typography.H5">
                            User Information from Microsoft Graph
                        </FluentLabel>

                        <FluentLabel Typo="Typography.Body">
                            Below is your user information retrieved from Microsoft Graph's <code>/me</code> API:
                        </FluentLabel>

                        <FluentStack Orientation="Orientation.Vertical"
                                     Style="background: var(--neutral-layer-2); padding: 1rem; border-radius: 4px; overflow-x: auto;">
                            <pre style="margin: 0;"><code class="language-json">@JsonSerializer.Serialize(graphApiResponse, new JsonSerializerOptions { WriteIndented = true })</code></pre>
                        </FluentStack>

                        <FluentMessageBar Intent="MessageIntent.Info">
                            Refreshing this page will continue to use the cached access token acquired for Microsoft Graph,
                            which is valid for future page views and will attempt to refresh this token as it nears its expiration.
                        </FluentMessageBar>
                    </FluentStack>
                </FluentCard>
            }
            else
            {
                <FluentCard>
                    <FluentStack Orientation="Orientation.Horizontal" HorizontalGap="16" VerticalAlignment="VerticalAlignment.Center">
                        <FluentProgressRing />
                        <FluentLabel Typo="Typography.Body">Loading your profile information...</FluentLabel>
                    </FluentStack>
                </FluentCard>
            }
        </Authorized>
    </AuthorizeView>
</FluentStack>

@code {
  [CascadingParameter]
  private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

  private JsonDocument? graphApiResponse = null;

  protected override async Task OnInitializedAsync()
  {
    var authState = await AuthenticationStateTask!;
    var user = authState.User;

    if (user.Identity?.IsAuthenticated == true)
    {
      try
      {
        using var response = await Http.GetAsync("https://graph.microsoft.com/v1.0/me");
        response.EnsureSuccessStatusCode();
        graphApiResponse = await response.Content.ReadFromJsonAsync<JsonDocument>().ConfigureAwait(false);
      }
      catch (AccessTokenNotAvailableException exception)
      {
        exception.Redirect();
      }
    }
  }
}
