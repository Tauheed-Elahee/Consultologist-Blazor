@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Text.Json
@using BlazorWasm.Services.AI
@using BlazorWasm.Services.Templates
@using Microsoft.JSInterop
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IConfiguration Configuration
@inject IAIEndpointService AIService
@inject ITemplateRenderService TemplateRenderService
@inject IJSRuntime JSRuntime
@attribute [Authorize]

@page "/consults"

<PageTitle>Consults</PageTitle>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="24">
    <FluentLabel Typo="Typography.H3">Consults</FluentLabel>

    <AuthorizeView>
        <Authorized>
            <FluentLabel>This a page for consults with authorized view</FluentLabel>

            <div class="consult-builder">
                <div class="consult-section">
                    <FluentLabel Typo="Typography.H5">Render context schema</FluentLabel>
                    <FluentSelect TOption="string"
                                  @bind-Value="selectedSchemaPath"
                                  Label="Select schema"
                                  Style="max-width: 420px;">
                        @foreach (var schema in schemaOptions)
                        {
                            <FluentOption TOption="string" Value="@schema.Path">@schema.Label</FluentOption>
                        }
                    </FluentSelect>
                    <FluentLabel Typo="Typography.Body">Schema path: @selectedSchemaPath</FluentLabel>
                </div>

                <div class="consult-section">
                    <FluentLabel Typo="Typography.H5">Consult details</FluentLabel>
                    <FluentTextArea @bind-Value="consultDraft"
                                     Label="Consult draft"
                                     Placeholder="Enter draft for the consult"
                                     Style="max-width: 420px;" />
                    <FluentButton Appearance="Appearance.Accent"
                                  @onclick="async () => { await LoadSchemaAsync(); await CreateAIRequestAsync(); }"
                                  Disabled="@(isSchemaLoading || isAiRequestLoading || string.IsNullOrEmpty(consultDraft))">
                        Create consult
                    </FluentButton>
                </div>

                <div class="consult-template-label">
@if (isTemplateLoading || isSchemaLoading || isAiRequestLoading)
{
	<FluentProgressRing />
}
@if (!string.IsNullOrEmpty(templateLoadError))
{
	<FluentMessageBar Intent="MessageIntent.Error">@templateLoadError</FluentMessageBar>
}
@if (!string.IsNullOrEmpty(schemaLoadError))
{
	<FluentMessageBar Intent="MessageIntent.Error">@schemaLoadError</FluentMessageBar>
}
@if (!string.IsNullOrEmpty(aiRequestError))
{
	<FluentMessageBar Intent="MessageIntent.Error">@aiRequestError</FluentMessageBar>
}
@if (isRenderLoading)
{
	<FluentProgressRing />
	<FluentLabel>Rendering template...</FluentLabel>
}
@if (!string.IsNullOrEmpty(renderError))
{
	<FluentMessageBar Intent="MessageIntent.Error">@renderError</FluentMessageBar>
}
@if (renderResult != null && !renderResult.Success)
{
	<FluentMessageBar Intent="MessageIntent.Error" Title="Template Rendering Errors">
		<ul style="margin: 0; padding-left: 20px;">
			@foreach (var error in renderResult.Errors)
			{
				<li>@error</li>
			}
		</ul>
	</FluentMessageBar>

	<details style="margin-top: 16px;">
		<summary style="cursor: pointer; color: #666;">Show Raw AI Response (JSON)</summary>
		<pre style="white-space: pre-wrap; word-wrap: break-word; font-size: 12px; margin-top: 8px; padding: 12px; background: #f5f5f5; border: 1px solid #ddd;">@aiResponse</pre>
	</details>
}
@if (renderResult?.Success == true && !string.IsNullOrEmpty(renderResult.RenderedHtml))
{
	<FluentCard>
		<FluentStack Orientation="Orientation.Horizontal">
			<FluentLabel Typo="Typography.H5" Style="flex: 1;">Consultation Note</FluentLabel>
			<FluentBadge Appearance="Appearance.Accent">
				Rendered in @renderResult.RenderDuration.TotalMilliseconds ms
			</FluentBadge>
		</FluentStack>

		<div style="border: 1px solid #ccc; padding: 24px; background: white; margin-top: 16px; max-height: 600px; overflow-y: auto;">
			@((MarkupString)renderResult.RenderedHtml)
		</div>
	</FluentCard>
}
                </div>
            </div>
        </Authorized>
    </AuthorizeView>
</FluentStack>

@code {
  [CascadingParameter]
  private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

  private JsonDocument? graphApiResponse = null;
  private readonly SchemaOption[] schemaOptions = new[]
  {
    new SchemaOption("Mortigen Render Context", "schemas/mortigen_render_context.schema.json")
  };
  private string selectedSchemaPath = "schemas/mortigen_render_context.schema.json";
  private string consultDraft = string.Empty;
  private string? renderedSchemaContent;
  private bool isSchemaLoading;
  private string? schemaLoadError;
  private bool isAiRequestLoading;
  private string? aiRequestError;
  private string? aiResponse;
  private string? renderedTemplateContent;
  private bool isTemplateLoading;
  private string? templateLoadError;
  private TemplateRenderResult? renderResult;
  private bool isRenderLoading;
  private string? renderError;

  protected override async Task OnInitializedAsync()
  {
    var authState = await AuthenticationStateTask!;
    var user = authState.User;

    if (user.Identity?.IsAuthenticated == true)
    {
      try
      {
        using var response = await Http.GetAsync("https://graph.microsoft.com/v1.0/me");
        response.EnsureSuccessStatusCode();
        graphApiResponse = await response.Content.ReadFromJsonAsync<JsonDocument>().ConfigureAwait(false);
      }
      catch (AccessTokenNotAvailableException exception)
      {
        exception.Redirect();
      }
    }
  }

  private async Task LoadConsultTemplateAsync()
  {
    templateLoadError = null;
    renderedTemplateContent = null;

    try
    {
      isTemplateLoading = true;
      var templateUri = new Uri(new Uri(Navigation.BaseUri), "templates/consult_template.liquid");
      renderedTemplateContent = await Http.GetStringAsync(templateUri);
    }
    catch (Exception ex)
    {
      templateLoadError = $"Unable to load template: {ex.Message}";
    }
    finally
    {
      isTemplateLoading = false;
    }
  }

  private async Task LoadSchemaAsync()
  {
    schemaLoadError = null;
    renderedSchemaContent = null;

    try
    {
      isSchemaLoading = true;
      var schemaUri = new Uri(new Uri(Navigation.BaseUri), selectedSchemaPath);
      renderedSchemaContent = await Http.GetStringAsync(schemaUri);
    }
    catch (Exception ex)
    {
      schemaLoadError = $"Unable to load schema: {ex.Message}";
    }
    finally
    {
      isSchemaLoading = false;
    }
  }

  private async Task CreateAIRequestAsync()
  {
    aiRequestError = null;
    aiResponse = null;
    renderResult = null; // Clear previous render

    if (!string.IsNullOrEmpty(consultDraft) && !string.IsNullOrEmpty(renderedSchemaContent))
    {
      try
      {
        isAiRequestLoading = true;
        aiResponse = await AIService.InvokeAgentAsync(consultDraft, renderedSchemaContent);

        // Log AI response to browser console
        if (!string.IsNullOrEmpty(aiResponse))
        {
          await JSRuntime.InvokeVoidAsync("console.log", "AI Response JSON:\n", aiResponse);

          // AUTO-RENDER: Load template and render after getting AI response
          await LoadConsultTemplateAsync();
          await RenderConsultTemplateAsync();
        }
      }
      catch (Exception ex)
      {
        aiRequestError = $"Error calling agent: {ex.Message}";
      }
      finally
      {
        isAiRequestLoading = false;
      }
    }
    else
    {
      aiRequestError = "Require both Consult Draft and loaded Schema";
    }
  }

  private async Task RenderConsultTemplateAsync()
  {
    renderError = null;
    renderResult = null;

    if (string.IsNullOrEmpty(aiResponse) || string.IsNullOrEmpty(renderedTemplateContent))
    {
      renderError = "Template and AI response required for rendering";
      return;
    }

    try
    {
      isRenderLoading = true;
      renderResult = await TemplateRenderService.RenderAsync(
        renderedTemplateContent,
        aiResponse);
    }
    catch (Exception ex)
    {
      renderError = $"Error rendering template: {ex.Message}";
    }
    finally
    {
      isRenderLoading = false;
    }
  }

  private sealed record SchemaOption(string Label, string Path);
}
