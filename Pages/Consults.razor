@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using System.Text.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IConfiguration Configuration
@attribute [Authorize]

@page "/consults"

<PageTitle>Consults</PageTitle>

<FluentStack Orientation="Orientation.Vertical" VerticalGap="24">
    <FluentLabel Typo="Typography.H3">Consults</FluentLabel>

    <AuthorizeView>
        <Authorized>
            <FluentLabel>This a page for consults with authorized view</FluentLabel>

            <div class="consult-builder">
                <div class="consult-section">
                    <FluentLabel Typo="Typography.H5">Render context schema</FluentLabel>
                    <FluentSelect TOption="string"
                                  @bind-Value="selectedSchemaPath"
                                  Label="Select schema"
                                  Style="max-width: 420px;">
                        @foreach (var schema in schemaOptions)
                        {
                            <FluentOption TOption="string" Value="@schema.Path">@schema.Label</FluentOption>
                        }
                    </FluentSelect>
                    <FluentLabel Typo="Typography.Body">Schema path: @selectedSchemaPath</FluentLabel>
                </div>

                <div class="consult-section">
                    <FluentLabel Typo="Typography.H5">Consult details</FluentLabel>
                    <FluentTextArea @bind-Value="consultDraft"
                                     Label="Consult draft"
                                     Placeholder="Enter draft for the consult"
                                     Style="max-width: 420px;" />
                    <FluentButton Appearance="Appearance.Accent"
                                  @onclick="async () => { await LoadSchemaAsync(); await CreateAIRequestAsync(); }"
                                  Disabled="@(isSchemaLoading || isAiRequestLoading || string.IsNullOrEmpty(consultDraft))">
                        Create consult
                    </FluentButton>
                </div>

                <div class="consult-template-label">
@if (isTemplateLoading || isSchemaLoading || isAiRequestLoading)
{
	<FluentProgressRing />
}
@if (!string.IsNullOrEmpty(templateLoadError))
{
	<FluentMessageBar Intent="MessageIntent.Error">@templateLoadError</FluentMessageBar>
}
@if (!string.IsNullOrEmpty(schemaLoadError))
{
	<FluentMessageBar Intent="MessageIntent.Error">@schemaLoadError</FluentMessageBar>
}
@if (!string.IsNullOrEmpty(aiRequestError))
{
	<FluentMessageBar Intent="MessageIntent.Error">@aiRequestError</FluentMessageBar>
}
@if (!string.IsNullOrEmpty(aiResponse))
{
	<div>
		<FluentLabel Typo="Typography.H6">AI Response:</FluentLabel>
		<pre style="white-space: pre-wrap; word-wrap: break-word;">@aiResponse</pre>
	</div>
}
                </div>
            </div>
        </Authorized>
    </AuthorizeView>
</FluentStack>

@code {
  [CascadingParameter]
  private Task<AuthenticationState>? AuthenticationStateTask { get; set; }

  private JsonDocument? graphApiResponse = null;
  private readonly SchemaOption[] schemaOptions = new[]
  {
    new SchemaOption("Mortigen Render Context", "schemas/mortigen_render_context.schema.json")
  };
  private string selectedSchemaPath = "schemas/mortigen_render_context.schema.json";
  private string consultDraft = string.Empty;
  private string? renderedSchemaContent;
  private bool isSchemaLoading;
  private string? schemaLoadError;
  private bool isAiRequestLoading;
  private string? aiRequestError;
  private string? aiRequest;
  private string? aiResponse;
  private string? renderedTemplateContent;
  private bool isTemplateLoading;
  private string? templateLoadError;

  protected override async Task OnInitializedAsync()
  {
    var authState = await AuthenticationStateTask!;
    var user = authState.User;

    if (user.Identity?.IsAuthenticated == true)
    {
      try
      {
        using var response = await Http.GetAsync("https://graph.microsoft.com/v1.0/me");
        response.EnsureSuccessStatusCode();
        graphApiResponse = await response.Content.ReadFromJsonAsync<JsonDocument>().ConfigureAwait(false);
      }
      catch (AccessTokenNotAvailableException exception)
      {
        exception.Redirect();
      }
    }
  }

  private async Task LoadConsultTemplateAsync()
  {
    templateLoadError = null;
    renderedTemplateContent = null;

    try
    {
      isTemplateLoading = true;
      var templateUri = new Uri(new Uri(Navigation.BaseUri), "templates/consult_template.liquid");
      renderedTemplateContent = await Http.GetStringAsync(templateUri);
    }
    catch (Exception ex)
    {
      templateLoadError = $"Unable to load template: {ex.Message}";
    }
    finally
    {
      isTemplateLoading = false;
    }
  }

  private async Task LoadSchemaAsync()
  {
    schemaLoadError = null;
    renderedSchemaContent = null;

    try
    {
      isSchemaLoading = true;
      var schemaUri = new Uri(new Uri(Navigation.BaseUri), selectedSchemaPath);
      renderedSchemaContent = await Http.GetStringAsync(schemaUri);
    }
    catch (Exception ex)
    {
      schemaLoadError = $"Unable to load schema: {ex.Message}";
    }
    finally
    {
      isSchemaLoading = false;
    }
  }

  private async Task CreateAIRequestAsync()
  {
    aiRequestError = null;
    aiResponse = null;

    if (!string.IsNullOrEmpty(consultDraft) && !string.IsNullOrEmpty(renderedSchemaContent))
    {
      try
      {
        isAiRequestLoading = true;

        // Read Azure AI configuration
        var endpoint = Configuration["AzureAI:Endpoint"];
        var agentId = Configuration["AzureAI:AgentId"];
        var apiKey = Configuration["AzureAI:ApiKey"];
        var apiVersion = Configuration["AzureAI:ApiVersion"] ?? "2025-05-01";

        if (string.IsNullOrEmpty(endpoint) || string.IsNullOrEmpty(agentId) || string.IsNullOrEmpty(apiKey))
        {
          aiRequestError = "Azure AI configuration is missing. Please check appsettings.";
          return;
        }

        // Build the message content
        var messageContent = $"Text: {consultDraft}\n\nJSON Schema: {renderedSchemaContent}";

        // Step 1: Create a thread
        var threadResponse = await SendAzureAIRequest(
          HttpMethod.Post,
          $"{endpoint}/threads?api-version={apiVersion}",
          apiKey,
          new { });
        var threadId = threadResponse.GetProperty("id").GetString();

        // Step 2: Add message to thread
        await SendAzureAIRequest(
          HttpMethod.Post,
          $"{endpoint}/threads/{threadId}/messages?api-version={apiVersion}",
          apiKey,
          new { role = "user", content = messageContent });

        // Step 3: Create run with agent ID
        var runResponse = await SendAzureAIRequest(
          HttpMethod.Post,
          $"{endpoint}/threads/{threadId}/runs?api-version={apiVersion}",
          apiKey,
          new { assistant_id = agentId });
        var runId = runResponse.GetProperty("id").GetString();

        // Step 4: Poll run status until complete
        JsonElement runStatusResponse;
        string runStatus;
        do
        {
          await Task.Delay(1000); // Wait 1 second between polls
          runStatusResponse = await SendAzureAIRequest(
            HttpMethod.Get,
            $"{endpoint}/threads/{threadId}/runs/{runId}?api-version={apiVersion}",
            apiKey,
            null);
          runStatus = runStatusResponse.GetProperty("status").GetString() ?? "";
        } while (runStatus == "queued" || runStatus == "in_progress" || runStatus == "cancelling");

        if (runStatus == "completed")
        {
          // Step 5: Retrieve messages
          var messagesResponse = await SendAzureAIRequest(
            HttpMethod.Get,
            $"{endpoint}/threads/{threadId}/messages?api-version={apiVersion}",
            apiKey,
            null);

          // Extract the assistant's response (first message in the list)
          if (messagesResponse.TryGetProperty("data", out var messages) && messages.GetArrayLength() > 0)
          {
            var assistantMessage = messages[0];
            if (assistantMessage.TryGetProperty("content", out var content) && content.GetArrayLength() > 0)
            {
              var textContent = content[0];
              if (textContent.TryGetProperty("text", out var text) &&
                  text.TryGetProperty("value", out var value))
              {
                aiResponse = value.GetString();
              }
            }
          }

          if (string.IsNullOrEmpty(aiResponse))
          {
            aiResponse = messagesResponse.ToString();
          }
        }
        else
        {
          aiRequestError = $"Run failed with status: {runStatus}";
        }
      }
      catch (HttpRequestException ex)
      {
        aiRequestError = $"HTTP error calling Azure AI: {ex.Message}";
      }
      catch (Exception ex)
      {
        aiRequestError = $"Unable to create AI request: {ex.Message}";
      }
      finally
      {
        isAiRequestLoading = false;
      }
    }
    else
    {
      aiRequestError = "Require both Consult Draft and loaded Schema";
    }
  }

  private async Task<JsonElement> SendAzureAIRequest(HttpMethod method, string url, string apiKey, object? body)
  {
    using var request = new HttpRequestMessage(method, url);
    request.Headers.Add("api-key", apiKey);

    if (body != null)
    {
      request.Content = JsonContent.Create(body);
    }

    using var response = await Http.SendAsync(request);
    response.EnsureSuccessStatusCode();

    var responseContent = await response.Content.ReadAsStringAsync();
    return JsonDocument.Parse(responseContent).RootElement;
  }

  private sealed record SchemaOption(string Label, string Path);
}
