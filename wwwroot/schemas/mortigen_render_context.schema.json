{
	"$schema": "https://json-schema.org/draft/2020-12/schema",
	"$id": "https://consultologist.ai/schemas/general_consultation.schema.json",
	"title": "General Consultation Note Schema",
	"description": "Structured schema for general medical consultation notes with optional oncology assessment fields",
	"type": "object",
	"additionalProperties": false,
	"required": [
		"patient",
		"encounter",
		"medications",
		"pastMedicalHistory",
		"allergies",
		"socialHistory",
		"familyHistory"
	],
	"properties": {
		"patient": {
			"type": "object",
			"$comment": "Patient demographic and identification information",
			"description": "Core patient demographics including name, age, sex, and preferred pronouns",
			"additionalProperties": false,
			"required": ["name", "age_years", "sex", "pronoun"],
			"properties": {
				"name": { "type": "string" },
				"full_name": { "type": "string" },
				"dob": { "type": "string" },
				"age_years": { "type": "integer", "minimum": 0, "maximum": 150 },
				"sex": {
					"type": "string",
					"enum": ["female", "male", "other", "unknown"]
				},
				"pronoun": {
					"type": "object",
					"additionalProperties": false,
					"required": ["nom", "gen", "obj", "refl"],
					"properties": {
						"nom": { "type": "string" },
						"gen": { "type": "string" },
						"obj": { "type": "string" },
						"refl": { "type": "string" }
					}
				}
			}
		},
		"encounter": {
			"$comment": "Encounter details",
			"description": "Details of the appointment with datetime, reason for consultation",
			"type": "object",
			"additionalProperties": false,
			"properties": {
				"datetime": { "type": "string" },
				"reason": { "type": "string" }
			}
		},
		"medications": {
			"$comment": "Array of medications",
			"description": "List of medications with name, dose, dose unit, route, frequency, prn, indication",
			"type": "array",
			"items": {
				"type": "object",
				"additionalProperties": false,
				"properties": {
					"label": { "type": "string" },
					"dose": { "type": ["string", "number"] },
					"dose_unit": { "type": "string" },
					"route": { "type": "string" },
					"frequency": { "type": "string" },
					"prn": { "type": "boolean" },
					"indication": { "type": ["string", "null"] }
				}
			}
		},
		"pastMedicalHistory": {
			"type": "object",
			"$comment": "Patient's past medical history including chronic conditions and comorbidities",
			"description": "Comprehensive past medical history covering major chronic diseases, conditions, and whether patient was previously healthy",
			"properties": {
				"COPD": {
					"type": "object",
					"$comment": "Chronic Obstructive Pulmonary Disease",
					"properties": {
						"diagnosed": { "type": "boolean" },
						"diagnosisMethod": {
							"type": "object",
							"properties": {
								"PFT": {
									"type": "object",
									"$comment": "Pulmonary Function Test",
									"properties": {
										"FEV1": {
											"type": ["number", "null"],
											"minimum": 0,
											"maximum": 10,
											"description": "Forced Expiratory Volume in 1 second, measured in liters"
										},
										"FVC_FEV1_ratio": {
											"type": ["number", "null"],
											"minimum": 0,
											"maximum": 1,
											"description": "Ratio of Forced Vital Capacity to FEV1, expressed as a decimal (0-1)"
										},
										"ventolinResponse": {
											"type": ["string", "null"],
											"description": "Patient response to Ventolin bronchodilator"
										}
									},
									"additionalProperties": false
								}
							},
							"additionalProperties": false
						},
						"lastHospitalization": {
							"type": ["string", "null"],
							"format": "date"
						},
						"respirologist": { "type": ["string", "null"] }
					},
					"required": ["diagnosed"],
					"additionalProperties": false,
					"if": {
						"properties": {
							"diagnosed": { "const": false }
						}
					},
					"then": {
						"properties": {
							"diagnosed": {},
							"diagnosisMethod": { "not": {} },
							"lastHospitalization": { "not": {} },
							"respirologist": { "not": {} }
						}
					}
				},

				"CKD": {
					"type": "object",
					"$comment": "Chronic Kidney Disease",
					"properties": {
						"previousDialysis": { "type": "boolean" },
						"kidneyMedications": {
							"type": "array",
							"items": { "type": "string" }
						},
						"creatinine": {
							"type": ["number", "null"],
							"minimum": 0,
							"maximum": 20,
							"description": "Serum creatinine level in mg/dL"
						},
						"eGFR": {
							"type": ["number", "null"],
							"minimum": 0,
							"maximum": 200,
							"description": "Estimated Glomerular Filtration Rate in mL/min/1.73mÂ²"
						},
						"lastHospitalization": {
							"type": ["string", "null"],
							"format": "date"
						},
						"nephrologist": { "type": ["string", "null"] }
					},
					"required": ["previousDialysis"],
					"additionalProperties": false,
					"if": {
						"properties": {
							"previousDialysis": { "const": false }
						}
					},
					"then": {
						"properties": {
							"previousDialysis": {},
							"kidneyMedications": { "maxItems": 0 },
							"creatinine": { "const": null },
							"eGFR": { "const": null },
							"lastHospitalization": { "const": null },
							"nephrologist": { "const": null }
						}
					}
				},

				"CAD": {
					"type": "object",
					"$comment": "Coronary Artery Disease",
					"properties": {
						"NYHA_class": {
							"type": ["string", "null"],
							"$comment": "New York Heart Association (NYHA) Functional Classification",
							"description": "NYHA functional classification of heart failure severity (I=mild, IV=severe)",
							"enum": ["I", "II", "III", "IV", null]
						},
						"degreeOfStenosis": {
							"type": "object",
							"properties": {
								"measuredByAngiography": { "type": ["string", "null"] },
								"type": {
									"type": ["string", "null"],
									"enum": ["Type I", "Type II", null]
								}
							},
							"additionalProperties": false
						},
						"lastHospitalization": {
							"type": ["string", "null"],
							"format": "date"
						},
						"cardiologist": { "type": ["string", "null"] }
					},
					"additionalProperties": false
				},

				"CHF": {
					"type": "object",
					"$comment": "Congestive Heart Failure",
					"properties": {
						"type": {
							"type": ["string", "null"],
							"description": "Heart failure type: HFpEF (preserved ejection fraction), HFmEF (mid-range), HFrEF (reduced)",
							"enum": ["HFpEF", "HFmEF", "HFrEF", null]
						},
						"echo": {
							"type": "object",
							"properties": {
								"date": {
									"type": ["string", "null"],
									"format": "date",
									"$comment": "ISO 8601 format: YYYY-MM-DD",
									"description": "Date of echocardiogram"
								},
								"ejectionFractionPercent": {
									"type": ["number", "null"],
									"minimum": 0,
									"maximum": 100,
									"description": "Left ventricular ejection fraction as a percentage"
								}
							},
							"additionalProperties": false
						},
						"medications": {
							"type": "array",
							"items": { "type": "string" }
						},
						"GDMT_medications": {
							"$comment": "Goal-directed medical therapy",
							"type": "array",
							"items": { "type": "string" }
						},
						"lastHospitalization": {
							"type": ["string", "null"],
							"format": "date"
						},
						"cardiologist": { "type": ["string", "null"] }
					},
					"additionalProperties": false
				},

				"diabetes": {
					"type": "object",
					"properties": {
						"diagnosed": { "type": "boolean" },
						"medications": {
							"type": "array",
							"items": { "type": "string" }
						},
						"endocrinologist": { "type": ["string", "null"] }
					},
					"required": ["diagnosed"],
					"additionalProperties": false,
					"if": {
						"properties": {
							"diagnosed": { "const": false }
						}
					},
					"then": {
						"properties": {
							"diagnosed": {},
							"medications": { "maxItems": 0 },
							"endocrinologist": { "const": null }
						}
					}
				},

				"strokes": {
					"type": "object",
					"properties": {
						"historyOfStroke": { "type": "boolean" },
						"lastHospitalization": {
							"type": ["string", "null"],
							"format": "date",
							"$comment": "ISO 8601 format: YYYY-MM-DD"
						},
						"medications": {
							"type": "array",
							"items": { "type": "string" }
						},
						"neurologist": { "type": ["string", "null"] }
					},
					"required": ["historyOfStroke"],
					"additionalProperties": false,
					"if": {
						"properties": {
							"historyOfStroke": { "const": false }
						}
					},
					"then": {
						"properties": {
							"historyOfStroke": {},
							"lastHospitalization": { "const": null },
							"medications": { "maxItems": 0 },
							"neurologist": { "const": null }
						}
					}
				},

				"atrialFibrillation": {
					"type": "object",
					"properties": {
						"diagnosed": { "type": "boolean" },
						"rateControlMedications": {
							"type": "array",
							"items": { "type": "string" }
						},
						"anticoagulation": { "type": ["string", "null"] },
						"lastHospitalization": {
							"type": ["string", "null"],
							"format": "date",
							"$comment": "ISO 8601 format: YYYY-MM-DD"
						},
						"cardiologist": { "type": ["string", "null"] }
					},
					"required": ["diagnosed"],
					"additionalProperties": false,
					"if": {
						"properties": {
							"diagnosed": { "const": false }
						}
					},
					"then": {
						"properties": {
							"diagnosed": {},
							"rateControlMedications": { "maxItems": 0 },
							"anticoagulation": { "const": null },
							"lastHospitalization": { "const": null },
							"cardiologist": { "const": null }
						}
					}
				},

				"osteoporosis": {
					"type": "object",
					"properties": {
						"diagnosed": { "type": "boolean" },
						"timeOfDiagnosis": { "type": ["string", "null"] },
						"boneScanResults": { "type": ["string", "null"] },
						"previousBirthControlUse": { "type": ["string", "null"] }
					},
					"required": ["diagnosed"],
					"additionalProperties": false,
					"if": {
						"properties": {
							"diagnosed": { "const": false }
						}
					},
					"then": {
						"properties": {
							"diagnosed": {},
							"timeOfDiagnosis": { "const": null },
							"boneScanResults": { "const": null },
							"previousBirthControlUse": { "const": null }
						}
					}
				},

				"dementia": {
					"type": "object",
					"properties": {
						"diagnosed": { "type": "boolean" },
						"followedBy": { "type": ["string", "null"] },
						"medications": {
							"type": "array",
							"items": { "type": "string" }
						},
						"gerontologist": { "type": ["string", "null"] }
					},
					"required": ["diagnosed"],
					"additionalProperties": false,
					"if": {
						"properties": {
							"diagnosed": { "const": false }
						}
					},
					"then": {
						"properties": {
							"diagnosed": {},
							"followedBy": { "const": null },
							"medications": { "maxItems": 0 },
							"gerontologist": { "const": null }
						}
					}
				},

				"otherPastMedicalHistory": {
					"type": "array",
					"items": { "type": "string" }
				},

				"previouslyHealthy": { "type": "boolean" }
			},
			"required": ["previouslyHealthy"],
			"additionalProperties": false
		},

		"allergies": {
			"type": "object",
			"$comment": "Patient allergy information including medications, foods, and environmental allergens",
			"description": "Comprehensive allergy history with allergen list, reactions, severity, and emergency medication status",
			"properties": {
				"list": {
					"type": "array",
					"items": {
						"type": "object",
						"properties": {
							"allergen": { "type": "string" },
							"reaction": { "type": "string" },
							"onset": {
								"type": "string",
								"enum": ["childhood", "adolescence", "adult"]
							}
						},
						"required": ["allergen", "reaction", "onset"],
						"additionalProperties": false
					}
				},
				"epipenPrescribed": { "type": "boolean" },
				"otherAntiAllergyMeds": {
					"type": "array",
					"items": { "type": "string" }
				},
				"noKnownDrugAllergies": { "type": "boolean" }
			},
			"required": ["epipenPrescribed", "noKnownDrugAllergies"],
			"additionalProperties": false
		},

		"socialHistory": {
			"type": "object",
			"$comment": "Patient's social history including lifestyle factors, living situation, and occupation",
			"description": "Social determinants of health covering smoking, alcohol, recreational drug use, living situation, and work environment",
			"properties": {
				"smoking": {
					"type": "object",
					"properties": {
						"status": {
							"type": "string",
							"enum": ["never", "previous", "current"]
						},
						"previous": {
							"type": "object",
							"properties": {
								"packsPerDay": {
									"type": ["number", "null"],
									"minimum": 0,
									"maximum": 10
								},
								"years": {
									"type": ["number", "null"],
									"minimum": 0,
									"maximum": 100
								},
								"quitYearsAgo": {
									"type": ["number", "null"],
									"minimum": 0,
									"maximum": 100
								}
							},
							"additionalProperties": false
						},
						"current": {
							"type": "object",
							"properties": {
								"packsPerDay": {
									"type": ["number", "null"],
									"minimum": 0,
									"maximum": 10
								},
								"startedYearsAgo": {
									"type": ["number", "null"],
									"minimum": 0,
									"maximum": 100
								},
								"type": {
									"type": "array",
									"items": {
										"type": "string",
										"enum": ["cigarettes", "marijuana"]
									}
								}
							},
							"additionalProperties": false
						}
					},
					"required": ["status"],
					"additionalProperties": false
				},

				"alcohol": {
					"type": "object",
					"properties": {
						"status": {
							"type": "string",
							"enum": ["never", "previous", "drinks"]
						},
						"drinksPerDay": {
							"type": ["number", "null"],
							"minimum": 0,
							"maximum": 50
						},
						"previous": {
							"type": "object",
							"properties": {
								"drinksPerDay": {
									"type": ["number", "null"],
									"minimum": 0,
									"maximum": 50
								},
								"quitYearsAgo": {
									"type": ["number", "null"],
									"minimum": 0,
									"maximum": 100
								}
							},
							"additionalProperties": false
						}
					},
					"required": ["status"],
					"additionalProperties": false
				},

				"recreationalDrugs": {
					"type": "object",
					"properties": {
						"used": { "type": "boolean" },
						"substances": {
							"type": "array",
							"items": {
								"type": "object",
								"properties": {
									"substance": { "type": "string" },
									"useFrequency": { "type": ["string", "null"] },
									"startedYearsAgo": {
										"type": ["number", "null"],
										"minimum": 0,
										"maximum": 100
									},
									"finishedYearsAgo": {
										"type": ["number", "null"],
										"minimum": 0,
										"maximum": 100
									}
								},
								"required": ["substance"],
								"additionalProperties": false
							}
						}
					},
					"required": ["used"],
					"additionalProperties": false
				},

				"livingSituation": {
					"type": "object",
					"properties": {
						"livesWith": {
							"type": "array",
							"items": {
								"type": "string",
								"enum": [
									"alone",
									"family",
									"spouse",
									"partner",
									"children",
									"pets",
									"roommate",
									"caregiver",
									"assisted living staff",
									"other"
								]
							}
						},
						"typeOfResidence": {
							"type": ["string", "null"],
							"enum": ["apartment", "house", null]
						},
						"hazards": {
							"type": "object",
							"properties": {
								"leadPipes": { "type": "boolean" },
								"insulationIssues": { "type": "boolean" }
							},
							"additionalProperties": false
						}
					},
					"additionalProperties": false
				},

				"work": {
					"type": "object",
					"properties": {
						"typeOfWork": { "type": ["string", "null"] },
						"standingWalkingRequired": { "type": ["string", "null"] },
						"exerciseRoutine": { "type": ["string", "null"] }
					},
					"additionalProperties": false
				}
			},
			"additionalProperties": false
		},

		"familyHistory": {
			"type": "object",
			"$comment": "Family medical history and genetic risk factors",
			"description": "Family history of medical conditions in first and second-degree relatives that may indicate genetic or familial risk",
			"properties": {
				"conditions": {
					"type": "array",
					"items": {
						"type": "object",
						"properties": {
							"condition": { "type": "string" },
							"familyMembers": {
								"type": "array",
								"items": {
									"type": "string",
									"enum": ["mother", "father", "sibling", "child", "other"]
								}
							}
						},
						"required": ["condition", "familyMembers"],
						"additionalProperties": false
					}
				},
				"unknownFamilyHistory": { "type": "boolean" }
			},
			"required": ["unknownFamilyHistory"],
			"additionalProperties": false
		},
		"assessment": {
			"type": "object",
			"$comment": "Optional oncology-specific assessment fields for cancer consultations",
			"description": "Oncology assessment including diagnosis, cancer staging, pathology results, receptor status, and genomic testing (e.g., Oncotype DX). Only populated for oncology consultations.",
			"additionalProperties": false,
			"properties": {
				"diagnosis": {
					"type": "array",
					"items": { "type": "string" }
				},
				"staging": {
					"type": "object",
					"additionalProperties": false,
					"required": ["stage_group", "tnm"],
					"properties": {
						"stage_group": {
							"type": "string",
							"pattern": "^Stage\\s*(0|I{1,3}(A|B|C)?|IV)$"
						},
						"tnm": {
							"type": "object",
							"additionalProperties": false,
							"required": ["prefix", "T", "N", "M"],
							"properties": {
								"prefix": {
									"type": "string",
									"enum": ["p", "c", "yp", "yc", "x"]
								},
								"T": {
									"type": "string",
									"pattern": "^T(is|1a|1b|1c|1|2|3|4[abcd]?)$"
								},
								"N": {
									"type": "string",
									"pattern": "^N(0|1[abc]?|2[ab]?|3[abc]?)$"
								},
								"M": { "type": "string", "pattern": "^M(0|1|X)$" }
							}
						}
					}
				},
				"pathology": {
					"type": "object",
					"additionalProperties": false,
					"required": [
						"histology",
						"grade",
						"tumor_size_cm",
						"nodes_examined",
						"nodes_positive"
					],
					"properties": {
						"histology": { "type": "string" },
						"grade": { "type": "string", "pattern": "^[123]$" },
						"tumor_size_cm": { "type": "number", "minimum": 0, "maximum": 20 },
						"dcis_present": { "type": "boolean" },
						"margins": { "type": "string" },
						"nodes_examined": { "type": "integer", "minimum": 0 },
						"nodes_positive": { "type": "integer", "minimum": 0 }
					}
				},
				"receptors": {
					"type": "object",
					"additionalProperties": false,
					"required": ["ER", "PR", "her2"],
					"properties": {
						"ER": { "type": "string", "pattern": "^[0-8]/8$" },
						"PR": { "type": "string", "pattern": "^[0-8]/8$" },
						"her2": {
							"type": "object",
							"additionalProperties": false,
							"properties": {
								"raw_text": { "type": "string" },
								"label": {
									"type": "string",
									"enum": [
										"HER2-positive",
										"HER2-negative",
										"HER2 status equivocal/unknown"
									]
								},
								"detail": { "type": "string" },
								"ihc_score": {
									"type": ["string", "null"],
									"enum": ["0", "1+", "2+", "3+", null]
								},
								"fish_result": {
									"type": ["string", "null"],
									"enum": [
										"positive",
										"negative",
										"equivocal",
										"not_done",
										null
									]
								}
							},
							"allOf": [
								{
									"if": { "required": ["label"] },
									"then": { "required": ["raw_text"] }
								}
							]
						}
					}
				},
				"oncotype": {
					"type": "object",
					"additionalProperties": false,
					"properties": {
						"score": { "type": "number", "minimum": 0, "maximum": 100 },
						"risk_yr": { "type": "integer", "minimum": 1, "maximum": 100 },
						"risk_percent": { "type": "number", "minimum": 0, "maximum": 100 },
						"absolute_benefit_percent": {
							"type": "number",
							"minimum": 0,
							"maximum": 100
						}
					},
					"allOf": [
						{
							"if": { "required": ["score"] },
							"then": { "required": ["risk_yr", "risk_percent"] }
						}
					]
				}
			}
		},
		"plan_structured": {
			"type": "object",
			"$comment": "Structured treatment plan for oncology patients",
			"description": "Oncology treatment plan with structured fields for endocrine therapy, radiation referral, and chemotherapy recommendations. Optional field for non-oncology consultations.",
			"additionalProperties": false,
			"properties": {
				"endocrine": {
					"type": "object",
					"additionalProperties": false,
					"properties": {
						"ordered": { "type": "boolean" },
						"agent": {
							"type": "string",
							"enum": ["letrozole", "tamoxifen", "other"]
						},
						"agent_other": { "type": ["string", "null"] }
					}
				},
				"radiation_referred": { "type": "boolean" },
				"chemotherapy": {
					"type": "object",
					"additionalProperties": false,
					"properties": {
						"recommended": { "type": "boolean" },
						"risk_basis": {
							"type": "string",
							"enum": [
								"low_oncotype",
								"high_oncotype",
								"high_risk_features",
								"her2_positive",
								"other"
							]
						},
						"regimen": {
							"type": ["string", "null"],
							"enum": ["BRAJACTG", "BRAJDC", "AC_TH", "TCH", null]
						},
						"regimen_other": { "type": ["string", "null"] }
					}
				}
			}
		},
		"content": {
			"type": "object",
			"$comment": "Free-text narrative sections of the consultation note",
			"description": "Unstructured text content for various sections of the consultation note (reason, HPI, PMH, medications, allergies, social, family, exam, investigations)",
			"additionalProperties": false,
			"properties": {
				"reason": { "type": ["string", "null"] },
				"hpi": { "type": ["string", "null"] },
				"pmh": { "type": ["string", "null"] },
				"meds": { "type": ["string", "null"] },
				"allergies": { "type": ["string", "null"] },
				"social": { "type": ["string", "null"] },
				"family": { "type": ["string", "null"] },
				"exam": { "type": ["string", "null"] },
				"investigations": { "type": ["string", "null"] }
			}
		},
		"extras": {
			"type": "object",
			"$comment": "Additional context-specific metadata",
			"description": "Extra metadata fields for specialized use cases (e.g., laterality for cancer side)",
			"additionalProperties": false,
			"properties": {
				"side": {
					"type": "string",
					"enum": ["left", "right"],
					"description": "Laterality for cases where side matters (e.g., breast cancer)"
				}
			}
		},
		"flags": {
			"type": "object",
			"$comment": "Boolean flags for document processing and rendering logic",
			"description": "Control flags used by rendering engine to determine what sections to display or how to format the output",
			"additionalProperties": false,
			"properties": {
				"exam_present": {
					"type": "boolean",
					"description": "Indicates whether physical exam section has content and should be rendered"
				}
			}
		}
	}
}
