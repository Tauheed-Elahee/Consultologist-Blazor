@using BlazorApp.Client.Services
@using BlazorApp.Client.Models
@inject AuthenticationService AuthService
@inject UserProfileService ProfileService

<div class="login-display">
    @if (isLoading)
    {
        <span>Loading...</span>
    }
    else if (isAuthenticated)
    {
        @if (loadingProfile)
        {
            <span class="user-info">Hello, loading...</span>
        }
        else if (profile != null)
        {
            <span class="user-info">Hello, @profile.DisplayName!</span>
        }
        else if (errorMessage != null)
        {
            <span class="user-info text-danger">@errorMessage</span>
        }
        else
        {
            <span class="user-info">Hello, User!</span>
        }
        <a href="/.auth/logout" class="btn btn-link">Logout</a>
    }
    else
    {
        <a href="/.auth/login/aad" class="btn btn-primary">Login</a>
    }
</div>

@code {
    private bool isAuthenticated = false;
    private bool isLoading = true;
    private bool loadingProfile = false;
    private UserProfile? profile;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Check if user is authenticated
            isAuthenticated = await AuthService.IsAuthenticatedAsync();
            isLoading = false;

            // If authenticated, fetch profile from Graph API
            if (isAuthenticated)
            {
                loadingProfile = true;
                try
                {
                    profile = await ProfileService.GetUserProfileAsync();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error loading user profile: {ex.Message}");
                    errorMessage = "Profile error";
                }
                finally
                {
                    loadingProfile = false;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in LoginDisplay: {ex.Message}");
            isLoading = false;
        }
    }
}
