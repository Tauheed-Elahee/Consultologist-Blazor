@using BlazorApp.Client.Services
@using BlazorApp.Client.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject UserProfileService ProfileService
@inject NavigationManager Navigation

<AuthorizeView>
    <Authorized>
        @if (loadingProfile)
        {
            <span class="user-info">Hello, loading...</span>
        }
        else if (profile != null)
        {
            <span class="user-info">Hello, @profile.DisplayName!</span>
        }
        else if (errorMessage != null)
        {
            <span class="user-info text-danger">@errorMessage</span>
        }
        else
        {
            <span class="user-info">Hello, @context.User.Identity?.Name!</span>
        }
        <a href="authentication/logout" class="btn btn-link">Logout</a>
    </Authorized>
    <NotAuthorized>
        <a href="authentication/login" class="btn btn-primary">Login</a>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool loadingProfile = false;
    private UserProfile? profile;
    private string? errorMessage;

    [CascadingParameter]
    private Task<AuthenticationState>? authenticationStateTask { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (authenticationStateTask != null)
        {
            var authState = await authenticationStateTask;
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                loadingProfile = true;
                try
                {
                    profile = await ProfileService.GetUserProfileAsync();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error loading user profile: {ex.Message}");
                    errorMessage = "Profile error";
                }
                finally
                {
                    loadingProfile = false;
                }
            }
        }
    }
}
